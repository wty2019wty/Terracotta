name: Rust-Cargo Build (Windows x86_64)

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      version:
        description: Terracotta Version
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  name: terracotta
  RUST_BACKTRACE: full
  TERRACOTTA_U_S: ${{ secrets.TERRACOTTA_U_S }}

defaults:
  run:
    shell: bash

jobs:
  build-windows-x86_64:
    runs-on: windows-latest
    name: Build (x86_64-pc-windows-msvc)
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install GitHub Artifact Client
        uses: lhotari/gh-actions-artifact-client@v2
      - name: Compute Version
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            echo "TERRACOTTA_VERSION=${GITHUB_SHA::7}" >> $GITHUB_ENV
          else
            echo "TERRACOTTA_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          fi
      - name: Build (Windows x86_64)
        run: |
          rustup target add --toolchain nightly "x86_64-pc-windows-msvc"
          rustup component add rust-src --toolchain "nightly-$(rustc --print host-tuple)"
          cargo +nightly build --release --bin terracotta --target "x86_64-pc-windows-msvc" \
            -Z build-std=core,std,alloc,proc_macro,panic_abort \
            -Z build-std-features=default,optimize_for_size
        env:
          RUSTFLAGS: -Zunstable-options -Cpanic=immediate-abort
      - name: Upload Artifact
        run: |
          source="terracotta-${TERRACOTTA_VERSION}-windows-x86_64.exe"
          cp "target/x86_64-pc-windows-msvc/release/terracotta.exe" "$source"
          7z a "$source.zip" "$source"
          cat "$source.zip" | gh-actions-artifact-client.js upload -r 90 "$source"
      # 可选：如果需要单独生成带 VCRUNTIME140.DLL 的打包文件（仅手动触发时）
      - name: Package with VCRUNTIME140 (Manual Trigger Only)
        if: ${{ github.event.inputs.version != '' }}
        run: |
          mkdir -p bundle
          curl -L -o VCRUNTIME140.DLL "https://github.com/burningtnt/Terracotta/raw/refs/heads/binaries/windows_x86_64/vcruntime140.dll"
          tar -czvf bundle/terracotta-${TERRACOTTA_VERSION}-windows-x86_64-pkg.tar.gz terracotta-${TERRACOTTA_VERSION}-windows-x86_64.exe VCRUNTIME140.DLL
          # 可选：创建 GitHub Release（如果需要）
          gh release create v"${{ github.event.inputs.version }}" -R "${{ github.repository }}" --draft --generate-notes bundle/terracotta-${TERRACOTTA_VERSION}-windows-x86_64-pkg.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
